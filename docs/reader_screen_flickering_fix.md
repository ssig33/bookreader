# Reader Screen Flickering Issue - 分析と解決策

## 問題の概要

**要求**: reader_screenに注目してほしいんだけど、これちらつくんだよね。画像がスクロールで遷移したあとちらつくわけ。なんか想像できる？

画像のスクロール遷移後にちらつく問題が報告されています。ユーザーがページをスクロールして次のページに移動した後、画面が一瞬ちらつくという現象が発生しています。

## コード分析

関連するファイルを分析した結果、以下のコンポーネントが画像表示とページ遷移に関わっています：

1. **ReaderScreen** (`lib/screens/reader/reader_screen.dart`)
   - PageView.builderを使用してページ遷移を管理
   - ページ変更時にsetState()を呼び出して状態を更新

2. **ReaderImageLoader** (`lib/screens/reader/reader_image_loader.dart`)
   - FutureBuilderを使用して非同期で画像を読み込む
   - 各ページの表示時に_fileService.getZipImageData()を呼び出して画像データを取得

3. **ReaderPageLayout** (`lib/screens/reader/reader_page_layout.dart`)
   - 単一ページと見開きページのレイアウトを管理
   - 画面のアスペクト比と画像のアスペクト比に基づいてレイアウトを決定

4. **ReaderNavigation** (`lib/screens/reader/reader_navigation.dart`)
   - ページ間のナビゲーションを管理
   - previousPage/nextPage（アニメーション付き）とjumpToPage（即時）の両方の遷移方法を使用

5. **FileService** (`lib/services/file_service.dart`)
   - ZIPファイルから画像を抽出してキャッシュ
   - 画像パスのみをキャッシュし、実際の画像データは都度ディスクから読み込む

## 考えられる原因

1. **非同期画像読み込み**：
   - 現在の実装では、ページが表示されるたびに`FutureBuilder`を使って画像を非同期で読み込んでいます。
   - ページ遷移中に、画像が完全に読み込まれる前に一瞬`CircularProgressIndicator`が表示されることがちらつきの原因になっている可能性があります。

2. **キャッシュの最適化不足**：
   - `FileService`の`_zipImageCache`は画像データ自体ではなく、抽出された画像のパスのみをキャッシュしています。
   - ページが表示されるたびに、ディスクから画像ファイルを読み込む必要があり、これが遅延やちらつきを引き起こす可能性があります。

3. **ページ遷移のアニメーション**：
   - `PageView`ウィジェットは300msの`easeInOut`アニメーションを使用しています。
   - このアニメーション中に次のページの画像が完全に読み込まれていないと、ちらつきが発生する可能性があります。

4. **プリロードの欠如**：
   - 現在の実装では隣接するページをプリロードしていません。必要になった時点でのみ読み込むため、遷移中にちらつきが発生する可能性があります。

5. **jumpToPageの使用**：
   - `navigateToRelativePage`メソッドでは`jumpToPage`を使用しており、これはアニメーションなしで即座にページを切り替えます。
   - この即時切り替えが、特に画像が完全に読み込まれる前に行われると、ちらつきの原因になる可能性があります。

## 実装済みの改善

ページ遷移時のちらつきを軽減するため、以下の改善を実装しました：

1. **メモリ内画像キャッシュの実装** (2025/3/21)
   - ReaderImageLoaderクラスにLRUキャッシュを実装
   - 最大10ページ分の画像データをメモリに保持
   - ディスクからの読み込み回数を削減

2. **隣接ページのプリロード機能の追加** (2025/3/21)
   - ページ変更時に前後のページを自動的にプリロード
   - 見開きページレイアウトに対応したプリロード処理
   - 範囲外のページを適切に処理

## 今後の改善候補（必要に応じて）

以下の項目は、現在の改善で十分な効果が得られない場合に追加実装を検討できます：

1. **AnimatedSwitcherを使用した画像遷移の最適化**
   - 画像切り替え時のアニメーション効果を追加
   - 画像間のスムーズな遷移を実現

2. **PageViewの設定調整**
   - viewportFractionプロパティの調整
   - カスタムページ遷移アニメーションの実装

3. **setState呼び出しの最適化**
   - 必要な部分のみを更新するよう最適化

4. **gaplessPlaybackの確認と調整**
   - 現在の実装の効果を検証